#!/sbin/sh

OUTFD=$2

ui_print() {
	echo -n -e "ui_print $1\n" > /proc/self/fd/$OUTFD
	echo -n -e "ui_print\n" > /proc/self/fd/$OUTFD
}

umount -l /system
umount -l /system1
umount -l /dev/block/mmcblk0p25
umount -l /dev/block/mmcblk0p26

ui_print ""
	ui_print "WARNING! Repartitioning will start in 2 seconds"
	sleep 2
	ui_print ""
	ui_print "Removing partitions..."
	parted /dev/block/mmcblk0 rm 25
	parted /dev/block/mmcblk0 rm 26
	ui_print "Removing partitions...COMPLETED"
	ui_print ""
	ui_print "Creating new partitions..."
	parted /dev/block/mmcblk0 mkpart primary 264MB 268MB
	parted /dev/block/mmcblk0 mkpart primary 268MB 940MB
	parted /dev/block/mmcblk0 mkpart primary 940MB 1611MB
	parted /dev/block/mmcblk0 name 25 BKE
	parted /dev/block/mmcblk0 name 26 APP
	parted /dev/block/mmcblk0 name 27 AP1
	ui_print "Creating new partitions...COMPLETED"
	ui_print ""
	ui_print "Unmounting systems partitions again..."
	umount -l /system
	umount -l /system1
	umount -l /dev/block/mmcblk0p26
	umount -l /dev/block/mmcblk0p27
	ui_print "Unmounting systems partitions again...COMPLETED"
	ui_print ""
	ui_print "Formatting new partitions..."
	mke2fs -b 4096 -T ext4 /dev/block/mmcblk0p26
	mke2fs -b 4096 -T ext4 /dev/block/mmcblk0p27
	ui_print "Formatting new partitions...COMPLETED."
	ui_print ""
	ui_print "ALL DONE!..."
	ui_print ""
	ui_print "Rebooting to recovery in 5 seconds..."
	sleep 5
	reboot recovery
fi
